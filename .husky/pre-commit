#!/bin/sh
# Format Rust code before commit (fast operation)
echo "üé® Formatting Rust code..."
cd rust && cargo fmt --all

if [ $? -ne 0 ]; then
  echo "‚ùå Rust formatting failed!"
  exit 1
fi

# Stage any Rust files that were formatted
git add -u "*.rs" 2>/dev/null || true
cd ..

echo "‚úÖ Rust code formatted!"

# Check that pnpm-lock.yaml doesn't contain platform-specific binaries
# These are generated locally and should not be committed
if grep -q "packages/cli/binaries/" pnpm-lock.yaml 2>/dev/null || \
   grep -q "packages/http-server/binaries/" pnpm-lock.yaml 2>/dev/null; then
  echo "‚ùå pnpm-lock.yaml contains platform binaries references!"
  echo ""
  echo "This happens when you run 'pnpm install' after building platform binaries."
  echo "To fix, run:"
  echo "  rm -rf packages/cli/binaries/*/ packages/http-server/binaries/*/"
  echo "  git checkout pnpm-lock.yaml"
  echo ""
  exit 1
fi

echo "‚úÖ pnpm-lock.yaml is clean!"
