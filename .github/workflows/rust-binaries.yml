name: Build Rust Binaries

on:
  # Trigger on version tags
  push:
    tags:
      - 'v*.*.*'
  
  # Manual trigger for testing/debugging
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish to npm after building'
        required: false
        type: boolean
        default: false
      debug:
        description: 'Enable debug logging'
        required: false
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false  # Continue other builds if one fails
      matrix:
        include:
          # macOS Intel
          - os: macos-latest
            target: x86_64-apple-darwin
            platform: darwin-x64
            
          # macOS Apple Silicon
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: darwin-arm64
            
          # Linux x64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux-x64
            
          # Linux ARM64 (cross-compile)
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            platform: linux-arm64
            
          # Windows x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: windows-x64

    steps:
      - uses: actions/checkout@v4
      
      # Enable debug logging if requested
      - name: Enable debug logging
        if: inputs.debug
        run: echo "CARGO_LOG=debug" >> $GITHUB_ENV
        shell: bash
      
      # Setup Rust toolchain
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      # Cache Rust dependencies
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-
      
      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-index-
      
      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: rust/target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-build-
      
      # Linux ARM64: Install cross-compilation tools
      - name: Install cross-compilation tools (Linux ARM64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
          
          # Configure Cargo linker
          mkdir -p ~/.cargo
          echo "[target.aarch64-unknown-linux-gnu]" >> ~/.cargo/config.toml
          echo 'linker = "aarch64-linux-gnu-gcc"' >> ~/.cargo/config.toml
      
      # Build binaries
      - name: Build CLI binary
        working-directory: rust
        run: cargo build --release --target ${{ matrix.target }} --package leanspec-cli
      
      - name: Build MCP binary
        working-directory: rust
        run: cargo build --release --target ${{ matrix.target }} --package leanspec-mcp
      
      # Debug: Show build artifacts
      - name: Debug - List build artifacts
        if: inputs.debug
        shell: bash
        run: |
          echo "=== Build artifacts ==="
          ls -la rust/target/${{ matrix.target }}/release/
      
      # Prepare artifacts
      - name: Prepare artifacts
        shell: bash
        run: |
          mkdir -p dist/${{ matrix.platform }}
          
          # Copy CLI binary
          if [ "${{ runner.os }}" = "Windows" ]; then
            cp rust/target/${{ matrix.target }}/release/lean-spec.exe dist/${{ matrix.platform }}/
          else
            cp rust/target/${{ matrix.target }}/release/lean-spec dist/${{ matrix.platform }}/
          fi
          
          # Copy MCP binary
          if [ "${{ runner.os }}" = "Windows" ]; then
            cp rust/target/${{ matrix.target }}/release/leanspec-mcp.exe dist/${{ matrix.platform }}/
          else
            cp rust/target/${{ matrix.target }}/release/leanspec-mcp dist/${{ matrix.platform }}/
          fi
          
          # Generate checksums
          cd dist/${{ matrix.platform }}
          if [ "${{ runner.os }}" = "Windows" ]; then
            certutil -hashfile lean-spec.exe SHA256 > lean-spec.exe.sha256
            certutil -hashfile leanspec-mcp.exe SHA256 > leanspec-mcp.exe.sha256
          else
            shasum -a 256 lean-spec > lean-spec.sha256
            shasum -a 256 leanspec-mcp > leanspec-mcp.sha256
          fi
          
          # Debug: Show prepared artifacts
          echo "=== Prepared artifacts ==="
          ls -la
      
      # Upload artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.platform }}
          path: dist/${{ matrix.platform }}
          retention-days: 30
  
  # Publish to npm (optional, requires secrets)
  publish:
    name: Publish to npm
    needs: build
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) || inputs.publish
    
    steps:
      - uses: actions/checkout@v4
      
      # Download all artifacts
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
      
      # Debug: Show downloaded artifacts
      - name: Debug - List downloaded artifacts
        if: inputs.debug
        run: |
          echo "=== Downloaded artifacts ==="
          find dist -type f -exec ls -la {} \;
      
      # Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      
      # Setup pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      
      # Install dependencies
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      # Copy binaries to npm-dist packages
      - name: Prepare platform packages
        run: |
          # CLI packages
          for platform in darwin-x64 darwin-arm64 linux-x64 linux-arm64 windows-x64; do
            mkdir -p rust/npm-dist/leanspec-cli-$platform/bin
            cp dist/binaries-$platform/lean-spec* rust/npm-dist/leanspec-cli-$platform/bin/
          done
          
          # MCP packages
          for platform in darwin-x64 darwin-arm64 linux-x64 linux-arm64 windows-x64; do
            mkdir -p rust/npm-dist/leanspec-mcp-$platform/bin
            cp dist/binaries-$platform/leanspec-mcp* rust/npm-dist/leanspec-mcp-$platform/bin/
          done
          
          echo "=== Platform packages prepared ==="
          find rust/npm-dist -name "bin" -type d -exec ls -la {} \;
      
      # Publish platform packages
      - name: Publish CLI platform packages
        run: |
          for platform in darwin-x64 darwin-arm64 linux-x64 linux-arm64 windows-x64; do
            echo "Publishing leanspec-cli-$platform..."
            cd rust/npm-dist/leanspec-cli-$platform
            OUTPUT=$(npm publish --provenance --access public 2>&1) || {
              if echo "$OUTPUT" | grep -q "You cannot publish over the previously published versions"; then
                echo "Version already published, skipping..."
              else
                echo "$OUTPUT"
                exit 1
              fi
            }
            echo "$OUTPUT"
            cd ../../..
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Publish MCP platform packages
        run: |
          for platform in darwin-x64 darwin-arm64 linux-x64 linux-arm64 windows-x64; do
            echo "Publishing leanspec-mcp-$platform..."
            cd rust/npm-dist/leanspec-mcp-$platform
            OUTPUT=$(npm publish --provenance --access public 2>&1) || {
              if echo "$OUTPUT" | grep -q "You cannot publish over the previously published versions"; then
                echo "Version already published, skipping..."
              else
                echo "$OUTPUT"
                exit 1
              fi
            }
            echo "$OUTPUT"
            cd ../../..
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
